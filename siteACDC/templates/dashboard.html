<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loja ACDC - Produtos</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<header>
  <img src="{{ url_for('static', filename='Logo_ACDC.png') }}" alt="Logo ACDC">
</header>

<nav class="nav-bar">
  <div class="nav-container">
    <div class="user-info">
      <span class="user-name">Bem-vindo, {{ usuario.nomeusu }}</span>
    </div>
    <div class="nav-actions">
      <a href="#" class="cart-icon" onclick="toggleCart()">
        üõí Carrinho
        <span class="cart-count" id="cart-count">0</span>
      </a>
      <a href="{{ url_for('logout') }}" class="btn btn-small">Logout</a>
    </div>
  </div>
</nav>

<div class="container">
  <h2>Nossos Produtos</h2>
  
  <!-- Search Bar -->
  <div class="search-container">
    <div class="search-box">
      <input 
        type="text" 
        class="search-input" 
        id="search-input" 
        placeholder="Buscar produtos por nome ou c√≥digo..."
        onkeyup="filtrarProdutos()"
      >
      <span class="search-icon">üîç</span>
    </div>
  </div>
  
  <!-- Cart Section (Initially Hidden) -->
  <div id="cart-section" class="cart-container" style="display: none;">
    <div class="cart-header">
      <h3 class="cart-title">üõí Seu Carrinho</h3>
      <button class="btn btn-small" onclick="toggleCart()">Fechar</button>
    </div>
    <div id="cart-items">
      <div class="empty-cart">
        <div class="empty-cart-icon">üõí</div>
        <p>Seu carrinho est√° vazio</p>
      </div>
    </div>
    <div id="cart-total" class="cart-total" style="display: none;">
      <div class="total-amount">
        Total: R$ <span id="total-value">0,00</span>
      </div>
      <button class="btn btn-success" onclick="finalizarPedido()" style="margin-top: 15px;">
        Finalizar Pedido
      </button>
    </div>
  </div>

  <!-- Products Table -->
  <div class="table-container">
    <table class="products-table">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Nome do Produto</th>
          <th>Pre√ßo</th>
          <th>Estoque</th>
          <th>Quantidade</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="products-tbody">
        {% for p in produtos %}
          <tr class="product-row fade-in" data-name="{{ p[1]|lower }}" data-code="{{ p[0]|lower }}">
            <td>
              <span class="product-code">{{ p[0] }}</span>
            </td>
            <td>
              <div class="product-name">{{ p[1] }}</div>
            </td>
            <td>
              <div class="product-price">R$ {{ "%.2f"|format(p[3] if p[3] else 0) }}</div>
            </td>
            <td>
              <span class="{% if p[2] > 10 %}stock-high{% elif p[2] > 5 %}stock-medium{% else %}stock-low{% endif %}">
                {{ p[2] }} un.
              </span>
            </td>
            <td>
              <input 
                type="number" 
                class="quantity-input" 
                id="qty-{{ p[0] }}" 
                min="1" 
                max="{{ p[2] }}" 
                value="1"
                {% if p[2] <= 0 %}disabled{% endif %}
              >
            </td>
            <td>
              <div class="action-buttons">
                <button 
                  class="btn btn-primary btn-small" 
                  onclick="adicionarAoCarrinho({{ p[0] }}, '{{ p[1]|replace("'", "\\'") }}', {{ p[3] if p[3] else 0 }}, {{ p[2] }})"
                  {% if p[2] <= 0 %}disabled{% endif %}
                >
                  {% if p[2] <= 0 %}
                    Sem Estoque
                  {% else %}
                    Adicionar
                  {% endif %}
                </button>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    
    <!-- No Products Found Message -->
    <div id="no-products" class="no-products" style="display: none;">
      <div class="no-products-icon">üîç</div>
      <h3>Nenhum produto encontrado</h3>
      <p>Tente buscar com outros termos</p>
    </div>
  </div>
</div>

<script>
let carrinho = [];

function toggleCart() {
  const cartSection = document.getElementById('cart-section');
  cartSection.style.display = cartSection.style.display === 'none' ? 'block' : 'none';
}

function adicionarAoCarrinho(codigo, nome, preco, estoque) {
  const quantidadeInput = document.getElementById(`qty-${codigo}`);
  const quantidade = parseInt(quantidadeInput.value);
  
  if (!quantidade || quantidade <= 0 || quantidade > estoque) {
    alert('Quantidade inv√°lida!');
    return;
  }
  
  // Verificar se o produto j√° est√° no carrinho
  const itemExistente = carrinho.find(item => item.codigo === codigo);
  
  if (itemExistente) {
    const novaQuantidade = itemExistente.quantidade + quantidade;
    if (novaQuantidade > estoque) {
      alert(`Quantidade m√°xima dispon√≠vel: ${estoque}`);
      return;
    }
    itemExistente.quantidade = novaQuantidade;
  } else {
    carrinho.push({
      codigo: codigo,
      nome: nome,
      preco: parseFloat(preco),
      quantidade: quantidade,
      estoque: estoque
    });
  }
  
  atualizarCarrinho();
  
  // Feedback visual
  const button = event.target;
  const originalText = button.textContent;
  const originalColor = button.style.background;
  
  button.textContent = 'Adicionado!';
  button.style.background = '#28a745';
  
  setTimeout(() => {
    button.textContent = originalText;
    button.style.background = originalColor;
  }, 1000);
}

function removerDoCarrinho(codigo) {
  carrinho = carrinho.filter(item => item.codigo !== codigo);
  atualizarCarrinho();
}

function alterarQuantidade(codigo, novaQuantidade) {
  const item = carrinho.find(item => item.codigo === codigo);
  if (item) {
    if (novaQuantidade <= 0) {
      removerDoCarrinho(codigo);
    } else if (novaQuantidade <= item.estoque) {
      item.quantidade = novaQuantidade;
      atualizarCarrinho();
    } else {
      alert(`Quantidade m√°xima dispon√≠vel: ${item.estoque}`);
      document.getElementById(`cart-qty-${codigo}`).value = item.quantidade;
    }
  }
}

function atualizarCarrinho() {
  const cartItems = document.getElementById('cart-items');
  const cartTotal = document.getElementById('cart-total');
  const cartCount = document.getElementById('cart-count');
  
  if (carrinho.length === 0) {
    cartItems.innerHTML = `
      <div class="empty-cart">
        <div class="empty-cart-icon">üõí</div>
        <p>Seu carrinho est√° vazio</p>
      </div>
    `;
    cartTotal.style.display = 'none';
    cartCount.textContent = '0';
    return;
  }
  
  let total = 0;
  let totalItens = 0;
  
  cartItems.innerHTML = carrinho.map(item => {
    const subtotal = item.preco * item.quantidade;
    total += subtotal;
    totalItens += item.quantidade;
    
    return `
      <div class="cart-item">
        <div class="cart-item-info">
          <div class="cart-item-name">${item.nome}</div>
          <div class="cart-item-details">
            C√≥digo: ${item.codigo} | R$ ${item.preco.toFixed(2)} cada
          </div>
        </div>
        <div class="cart-item-actions">
          <input 
            type="number" 
            class="quantity-input" 
            id="cart-qty-${item.codigo}"
            value="${item.quantidade}" 
            min="1" 
            max="${item.estoque}"
            onchange="alterarQuantidade(${item.codigo}, parseInt(this.value))"
          >
          <span style="color: #28a745; font-weight: 600; min-width: 80px;">
            R$ ${subtotal.toFixed(2)}
          </span>
          <button class="btn btn-small" onclick="removerDoCarrinho(${item.codigo})" style="background: #dc3545;">
            ‚ùå
          </button>
        </div>
      </div>
    `;
  }).join('');
  
  document.getElementById('total-value').textContent = total.toFixed(2);
  cartTotal.style.display = 'block';
  cartCount.textContent = totalItens;
}

async function finalizarPedido() {
  if (carrinho.length === 0) {
    alert('Carrinho vazio!');
    return;
  }
  
  const button = event.target;
  const originalText = button.textContent;
  button.innerHTML = '<span class="loading"></span> Processando...';
  button.disabled = true;
  
  try {
    const response = await fetch('/finalizar_pedido', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        itens: carrinho
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert(`Pedido realizado com sucesso! N√∫mero do pedido: ${result.pedido_id}`);
      carrinho = [];
      atualizarCarrinho();
      toggleCart();
      // Recarregar a p√°gina para atualizar o estoque
      location.reload();
    } else {
      alert('Erro ao processar pedido: ' + result.message);
    }
  } catch (error) {
    alert('Erro ao processar pedido. Tente novamente.');
    console.error('Erro:', error);
  } finally {
    button.textContent = originalText;
    button.disabled = false;
  }
}

function filtrarProdutos() {
  const searchTerm = document.getElementById('search-input').value.toLowerCase();
  const rows = document.querySelectorAll('.product-row');
  const noProductsMsg = document.getElementById('no-products');
  let visibleCount = 0;
  
  rows.forEach(row => {
    const name = row.getAttribute('data-name');
    const code = row.getAttribute('data-code');
    
    if (name.includes(searchTerm) || code.includes(searchTerm)) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });
  
  // Mostrar mensagem se nenhum produto for encontrado
  if (visibleCount === 0 && searchTerm !== '') {
    noProductsMsg.style.display = 'block';
  } else {
    noProductsMsg.style.display = 'none';
  }
}

// Inicializar carrinho ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
  atualizarCarrinho();
});
</script>

</body>
</html>