{% extends 'base.html' %}
{% block title %}Status do Token Bling{% endblock %}

{% block content %}
  <h1>üîê Status do Token Bling API</h1>

  <div class="status-item {{ 'status-valid' if status == 'v√°lido' else 'status-invalid' }}">
    <div class="status-label">
      <span class="icon">üîë</span>
      Token de Acesso:
    </div>
    <div class="status-value">{{ access_token[:50] }}...</div>
  </div>

  <div class="status-item">
    <div class="status-label">
      <span class="icon">üïê</span>
      √öltima Atualiza√ß√£o:
    </div>
    <div class="status-value">
      <div class="datetime-info">
        <div class="datetime-primary" id="last-refresh-formatted" data-raw="{{ last_refresh }}">{{ last_refresh }}</div>
        <div class="datetime-secondary" id="last-refresh-relative"></div>
      </div>
    </div>
  </div>

  <div class="status-item">
    <div class="status-label">
      <span class="icon">‚è∞</span>
      Pr√≥xima Atualiza√ß√£o:
    </div>
    <div class="status-value">
      <div class="datetime-info">
        <div class="datetime-primary" id="next-refresh-formatted" data-raw="{{ next_refresh }}">{{ next_refresh }}</div>
        <div class="datetime-secondary" id="next-refresh-relative"></div>
      </div>
    </div>
  </div>

  <div class="status-item {{ 'status-valid' if status == 'v√°lido' else 'status-invalid' }}">
    <div class="status-label">
      <span class="status-indicator {{ 'indicator-valid' if status == 'v√°lido' else 'indicator-invalid' }}"></span>
      <span class="icon">üìä</span>
      Status:
    </div>
    <div class="status-value">{{ status.upper() }}</div>
  </div>

  <button class="refresh-button" onclick="refreshToken()">üîÑ Atualizar Token Agora</button>
{% endblock %}

{% block scripts %}
<script>
  function formatDateTime(dateString) {
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
      const formattedDate = date.toLocaleDateString('pt-BR', options);
      const formattedTime = date.toLocaleTimeString('pt-BR', timeOptions);
      return `${formattedDate}, ${formattedTime}`;
    } catch { return dateString; }
  }
  function getRelativeTime(dateString) {
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '';
      const now = new Date();
      const diffMs = now - date;
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMinutes / 60);
      const diffDays = Math.floor(diffHours / 24);
      if (diffMinutes < 1) return 'Agora mesmo';
      if (diffMinutes < 60) return `${diffMinutes} minuto${diffMinutes > 1 ? 's' : ''} atr√°s`;
      if (diffHours < 24) return `${diffHours} hora${diffHours > 1 ? 's' : ''} atr√°s`;
      return `${diffDays} dia${diffDays > 1 ? 's' : ''} atr√°s`;
    } catch { return ''; }
  }
  function getTimeUntil(dateString) {
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '';
      const now = new Date();
      const diffMs = date - now;
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMinutes / 60);
      const diffDays = Math.floor(diffHours / 24);
      if (diffMs < 0) return 'Atrasado';
      if (diffMinutes < 1) return 'Em breve';
      if (diffMinutes < 60) return `Em ${diffMinutes} minuto${diffMinutes > 1 ? 's' : ''}`;
      if (diffHours < 24) return `Em ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
      return `Em ${diffDays} dia${diffDays > 1 ? 's' : ''}`;
    } catch { return ''; }
  }
  function updateDateTimeDisplay() {
    const lastEl = document.getElementById('last-refresh-formatted');
    const lastRel = document.getElementById('last-refresh-relative');
    if (lastEl && lastRel) {
      const raw = lastEl.getAttribute('data-raw');
      lastEl.textContent = formatDateTime(raw);
      lastRel.textContent = getRelativeTime(raw);
    }
    const nextEl = document.getElementById('next-refresh-formatted');
    const nextRel = document.getElementById('next-refresh-relative');
    if (nextEl && nextRel) {
      const raw = nextEl.getAttribute('data-raw');
      nextEl.textContent = formatDateTime(raw);
      nextRel.textContent = getTimeUntil(raw);
    }
  }
  function refreshToken() {
    const button = document.querySelector('.refresh-button');
    button.disabled = true;
    button.innerHTML = '‚è≥ Atualizando...';
    fetch('/refresh-token', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
      .then(r => r.json())
      .then(d => {
        if (d.success) { alert('‚úÖ Token atualizado com sucesso!'); location.reload(); }
        else { alert('‚ùå Erro ao atualizar token: ' + d.error); }
      })
      .catch(e => alert('‚ö†Ô∏è Erro na requisi√ß√£o: ' + e))
      .finally(() => { button.disabled = false; button.innerHTML = 'üîÑ Atualizar Token Agora'; });
  }
  document.addEventListener('DOMContentLoaded', () => {
    updateDateTimeDisplay();
    setInterval(updateDateTimeDisplay, 60000);
  });
</script>
{% endblock %}